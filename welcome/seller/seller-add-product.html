<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add Product â€” Local Basket</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="seller-dashboard.css"> <style>
    /* Form Specific Styles */
    .form-card {
      max-width: 600px;
      margin: 20px auto;
      background: var(--card);
      padding: 30px;
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border-color);
    }
    .form-header {
      text-align: center;
      margin-bottom: 25px;
    }
    .form-header i {
      font-size: 40px;
      color: var(--lav);
      margin-bottom: 10px;
    }
    .form-group {
      margin-bottom: 18px;
    }
    .form-group label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--text);
    }
    input, select {
      width: 100%;
      padding: 12px 15px;
      border-radius: 10px;
      border: 1px solid var(--border-color);
      background: var(--bg);
      color: var(--text);
      font-family: inherit;
      font-size: 14px;
      transition: 0.3s;
    }
    input:focus, select:focus {
      outline: none;
      border-color: var(--lav);
      box-shadow: 0 0 0 3px var(--lav-soft);
    }
    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    .file-input-wrapper {
      position: relative;
      border: 2px dashed var(--border-color);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: 0.3s;
    }
    .file-input-wrapper:hover {
      border-color: var(--lav);
      background: var(--lav-soft);
    }
    .preview-grid {
      margin-top: 12px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(82px, 1fr));
      gap: 8px;
    }
    .preview-thumb {
      width: 100%;
      aspect-ratio: 1 / 1;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: #fff;
    }
    .preview-item {
      position: relative;
    }
    .preview-remove {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 20px;
      height: 20px;
      border: none;
      border-radius: 999px;
      background: rgba(17, 24, 39, 0.78);
      color: #fff;
      font-size: 12px;
      line-height: 1;
      cursor: pointer;
    }
    .field-hint {
      color: var(--text-light);
      font-size: 12px;
      display: block;
      margin-top: 4px;
    }
    .price-insight {
      margin-top: 8px;
      padding: 10px 12px;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      background: var(--bg);
      color: var(--text-light);
      font-size: 12px;
      display: none;
    }
    .price-insight strong {
      color: var(--lav);
      font-weight: 700;
    }
    .action-row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      margin-top: 10px;
    }
    .btn-secondary {
      border: 1px solid var(--border-color);
      background: var(--bg);
      color: var(--text);
      border-radius: 10px;
      font-weight: 600;
      padding: 12px 14px;
      cursor: pointer;
    }
    .lb-popup-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      backdrop-filter: blur(2px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      padding: 16px;
    }
    .lb-popup-overlay.open { display: flex; }
    .lb-popup {
      width: min(420px, 100%);
      background: #fff;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 20px 40px rgba(2, 6, 23, 0.2);
      overflow: hidden;
    }
    .lb-popup-head {
      padding: 14px 16px;
      font-weight: 700;
      font-size: 15px;
      border-bottom: 1px solid #f1f5f9;
      background: #f8fafc;
      color: #111827;
    }
    .lb-popup-body {
      padding: 16px;
      font-size: 14px;
      color: #374151;
      line-height: 1.45;
    }
    .lb-popup-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      padding: 0 16px 16px;
    }
    .lb-popup-btn {
      border: 0;
      border-radius: 10px;
      padding: 10px 16px;
      font-weight: 600;
      color: #fff;
      cursor: pointer;
      background: linear-gradient(135deg, #ff8a1a 0%, #e56a00 100%);
    }
    .lb-popup.success .lb-popup-head { color: #065f46; background: #ecfdf5; }
    .lb-popup.error .lb-popup-head { color: #991b1b; background: #fef2f2; }
  </style>
</head>
<body>

<header class="mobile-header">
  <button id="menuBtn"><i class="fas fa-bars"></i></button>
  <span class="logo-text-mobile">Add Product</span>
</header>

<div id="sidebarOverlay"></div>

<aside class="sidebar" id="sidebar">
  <div class="brand">
    <img src="/welcome/logo2.png">
    <h3>Local Basket</h3>
    <p>Admin Dashboard</p>
  </div>
  <nav class="nav-menu">
    <ul>
      <li><a href="seller-dashboard.html" class="nav-link"><i class="fas fa-chart-line"></i> Dashboard</a></li>
      <li><a href="seller-pocket.html" class="nav-link"><i class="fas fa-wallet"></i> My Pocket</a></li>
      <li><a href="seller-add-product.html" class="nav-link active"><i class="fas fa-plus-circle"></i> Add Product</a></li>
      <li><a href="seller-products.html" class="nav-link"><i class="fas fa-boxes-stacked"></i> My Products</a></li>
      <li><a href="seller-orders.html" class="nav-link"><i class="fas fa-receipt"></i> All Orders</a></li>
      <li><a href="seller-profile.html" class="nav-link"><i class="fas fa-store"></i> Shop Profile</a></li>
      <li class="logout-item"><button onclick="logout()" class="btn-logout"><i class="fas fa-sign-out-alt"></i> Logout</button></li>
    </ul>
  </nav>
</aside>

<main class="main">
  <button class="sidebar-open-btn" onclick="sidebar.classList.add('open'); sidebarOverlay.style.display='block';">
    <i class="fas fa-bars"></i> Menu
  </button>
  <div class="top-bar">
    <div class="shop-info">
      <div class="text-info">
        <h3 style="color: var(--lav); font-weight: 700;">+ Add New Product</h3>
        <span class="badge">Inventory Management</span>
      </div>
    </div>
    <div class="toggles">
      <div class="toggle-pill theme-toggle">
        <i class="fas fa-moon"></i>
        <label class="switch">
          <input type="checkbox" id="themeToggle">
          <span class="slider"></span>
        </label>
      </div>
    </div>
  </div>

  <div class="form-card">
    <div class="form-header">
      <i class="fas fa-cloud-upload-alt"></i>
      <p style="color: var(--text-light); font-size: 14px;">Fill the details below to list a new product</p>
    </div>

    <div class="form-group">
      <label>Product Name *</label>
      <input id="pname" type="text" placeholder="e.g. Fresh Red Apples" required>
    </div>

    <div class="form-group">
      <label>Category *</label>
      <select id="category">
        <option value="">Select Category</option>
      </select>
    </div>

    <div class="form-group">
      <label>Sub-category (max 3 words)</label>
      <input id="subcategory" type="text" placeholder="e.g. Organic Apples" maxlength="30">
      <small class="field-hint">Seller can add up to 3 words.</small>
      <small class="field-hint">
        This will be shown in the product popup/details view for customers.
      </small>
      <small class="field-hint" id="subcategoryCount">0/3 words</small>
    </div>

    <div class="row">
      <div class="form-group">
        <label>Selling Price (Rs.) *</label>
        <input id="price" type="number" placeholder="0.00" min="0" step="0.01" required>
      </div>
      <div class="form-group">
        <label>MRP (Optional)</label>
        <input id="mrp" type="number" placeholder="0.00">
      </div>
    </div>
    <div id="priceInsight" class="price-insight"></div>

    <div class="row">
      <div class="form-group">
        <label>Unit *</label>
        <select id="unit">
          <option value="">Select Unit</option>
          <option value="250g">250 gram packet</option>
          <option value="500g">500 gram packet</option>
          <option value="1kg">1 kg</option>
          <option value="500ml">500 ml bottle</option>
          <option value="1ltr">1 litre bottle</option>
          <option value="dozen">Dozen</option>
          <option value="box">Box</option>
          <option value="bottle">Bottle</option>
          <option value="packet">Packet</option>
          <option value="pcs">Pieces</option>
        </select>
      </div>
      <div class="form-group">
        <label>Stock Quantity *</label>
        <input id="stock" type="number" placeholder="Enter quantity" min="0" step="1" required>
      </div>
    </div>


    <div class="form-group">
      <label>Product Images *</label>
      <div class="file-input-wrapper" onclick="document.getElementById('image').click()">
        <i class="fas fa-image" style="display:block; font-size: 24px; color: var(--lav); margin-bottom: 5px;"></i>
        <span id="imageLabel" style="font-size: 12px; color: var(--text-light);">Click to upload product images</span>
        <input id="image" type="file" accept="image/*" style="display:none" multiple required>
      </div>
      <small class="field-hint">You can upload up to 8 images.</small>
      <div id="previewGrid" class="preview-grid"></div>
    </div>

    <div class="action-row">
      <button id="submitBtn" class="btn-accept" onclick="addProduct()" style="width: 100%; padding: 14px; font-size: 16px;">
        <i class="fas fa-plus"></i> List Product
      </button>
      <button id="clearDraftBtn" type="button" class="btn-secondary">Clear Draft</button>
    </div>
  </div>
</main>
<div class="lb-popup-overlay" id="lbPopupOverlay">
  <div class="lb-popup" id="lbPopupBox" role="dialog" aria-modal="true">
    <div class="lb-popup-head" id="lbPopupTitle">Notice</div>
    <div class="lb-popup-body" id="lbPopupMsg"></div>
    <div class="lb-popup-actions">
      <button type="button" class="lb-popup-btn" id="lbPopupOk">OK</button>
    </div>
  </div>
</div>

<script>
/* ================= AUTH & NAV ================= */
const seller = JSON.parse(localStorage.getItem("lbSeller"));
if(!seller) location.href="./seller-auth/seller-auth.html";

function go(p){ location.href=p }
function logout(){ localStorage.removeItem("lbSeller"); location.href="./seller-auth/seller-auth.html"; }

/* ================= UI LOGIC ================= */
const menuBtn = document.getElementById("menuBtn");
const sidebar = document.getElementById("sidebar");
const overlay = document.getElementById("sidebarOverlay");
const themeToggle = document.getElementById("themeToggle");

menuBtn.onclick = () => { sidebar.classList.add("open"); overlay.style.display="block"; }
overlay.onclick = () => { sidebar.classList.remove("open"); overlay.style.display="none"; }

// Theme Toggle
themeToggle.onchange = () => {
  document.body.classList.toggle('dark', themeToggle.checked);
  localStorage.setItem('theme', themeToggle.checked ? 'dark' : 'light');
};
if(localStorage.getItem('theme') === 'dark') { themeToggle.checked = true; document.body.classList.add('dark'); }

/* ================= IMAGE PREVIEW ================= */
const imageInput = document.getElementById("image");
const previewGrid = document.getElementById("previewGrid");
const imageLabel = document.getElementById("imageLabel");
const subcategoryInput = document.getElementById("subcategory");
const subcategoryCount = document.getElementById("subcategoryCount");
const priceInput = document.getElementById("price");
const mrpInput = document.getElementById("mrp");
const stockInput = document.getElementById("stock");
const priceInsight = document.getElementById("priceInsight");
const submitBtn = document.getElementById("submitBtn");
const clearDraftBtn = document.getElementById("clearDraftBtn");
const DRAFT_KEY = `lbAddProductDraft:${seller?.id || "guest"}`;
const lbPopupOverlay = document.getElementById("lbPopupOverlay");
const lbPopupBox = document.getElementById("lbPopupBox");
const lbPopupTitle = document.getElementById("lbPopupTitle");
const lbPopupMsg = document.getElementById("lbPopupMsg");
const lbPopupOk = document.getElementById("lbPopupOk");
let selectedImageFiles = [];

function showPopup(message, options = {}) {
  const title = options.title || "Notice";
  const type = options.type === "error" ? "error" : "success";
  lbPopupBox.classList.remove("success", "error");
  lbPopupBox.classList.add(type);
  lbPopupTitle.textContent = title;
  lbPopupMsg.textContent = String(message || "");
  lbPopupOverlay.classList.add("open");
  return new Promise((resolve) => {
    const close = () => {
      lbPopupOverlay.classList.remove("open");
      lbPopupOk.removeEventListener("click", onOk);
      resolve();
    };
    const onOk = () => close();
    lbPopupOk.addEventListener("click", onOk);
  });
}

function renderImageSelection() {
  if (imageLabel) {
    imageLabel.textContent = selectedImageFiles.length
      ? `${selectedImageFiles.length} image${selectedImageFiles.length > 1 ? "s" : ""} selected`
      : "Click to upload product images";
  }
  if (!previewGrid) return;
  previewGrid.innerHTML = "";
  selectedImageFiles.forEach((file, idx) => {
    const reader = new FileReader();
    reader.onload = () => {
      const wrap = document.createElement("div");
      wrap.className = "preview-item";
      wrap.innerHTML = `
        <img class="preview-thumb" alt="${file.name || "Product image"}">
        <button type="button" class="preview-remove" title="Remove image">&times;</button>
      `;
      const img = wrap.querySelector("img");
      const removeBtn = wrap.querySelector("button");
      if (img) img.src = reader.result;
      if (removeBtn) {
        removeBtn.addEventListener("click", () => {
          selectedImageFiles.splice(idx, 1);
          renderImageSelection();
        });
      }
      previewGrid.appendChild(wrap);
    };
    reader.readAsDataURL(file);
  });
}

imageInput.onchange = () => {
  const incoming = Array.from(imageInput.files || []);
  if (!incoming.length) return;

  incoming.forEach((file) => {
    const key = `${file.name}|${file.size}|${file.lastModified}`;
    const exists = selectedImageFiles.some(
      (f) => `${f.name}|${f.size}|${f.lastModified}` === key
    );
    if (!exists && selectedImageFiles.length < 8) {
      selectedImageFiles.push(file);
    }
  });
  renderImageSelection();
  imageInput.value = "";
};

if (subcategoryInput) {
  subcategoryInput.addEventListener("input", () => {
    const words = subcategoryInput.value.trim().split(/\s+/).filter(Boolean);
    if (words.length > 3) {
      subcategoryInput.value = words.slice(0, 3).join(" ");
    }
    updateSubcategoryCount();
    saveDraft();
  });
}

function updateSubcategoryCount() {
  if (!subcategoryInput || !subcategoryCount) return;
  const words = subcategoryInput.value.trim().split(/\s+/).filter(Boolean);
  subcategoryCount.textContent = `${Math.min(words.length, 3)}/3 words`;
}

function updatePriceInsight() {
  if (!priceInsight) return;
  const price = Number(priceInput?.value || 0);
  const mrp = Number(mrpInput?.value || 0);
  if (!price || !mrp || mrp <= price) {
    priceInsight.style.display = "none";
    priceInsight.textContent = "";
    return;
  }
  const discount = Math.round(((mrp - price) / mrp) * 100);
  const saveRs = (mrp - price).toFixed(2);
  priceInsight.style.display = "block";
  priceInsight.innerHTML = `Customer saves <strong>Rs. ${saveRs}</strong> (<strong>${discount}% OFF</strong>)`;
}

function getDraft() {
  return {
    pname: document.getElementById("pname").value.trim(),
    category: document.getElementById("category").value,
    subcategory: document.getElementById("subcategory").value.trim(),
    unit: document.getElementById("unit").value,
    price: document.getElementById("price").value,
    mrp: document.getElementById("mrp").value,
    stock: document.getElementById("stock").value
  };
}

function saveDraft() {
  try {
    localStorage.setItem(DRAFT_KEY, JSON.stringify(getDraft()));
  } catch {}
}

function restoreDraft() {
  try {
    const raw = localStorage.getItem(DRAFT_KEY);
    if (!raw) return;
    const d = JSON.parse(raw);
    if (!d || typeof d !== "object") return;
    if (d.pname) document.getElementById("pname").value = d.pname;
    if (!document.getElementById("category").disabled && d.category) document.getElementById("category").value = d.category;
    if (d.subcategory) document.getElementById("subcategory").value = d.subcategory;
    if (d.unit) document.getElementById("unit").value = d.unit;
    if (d.price) document.getElementById("price").value = d.price;
    if (d.mrp) document.getElementById("mrp").value = d.mrp;
    if (d.stock) document.getElementById("stock").value = d.stock;
  } catch {}
}


/* ================= LOAD CATEGORY OPTIONS ================= */
async function loadCategories() {
  try {
    const res = await fetch("https://localbasket-backend.onrender.com/api/admin/categories");
    const data = await res.json();
    const list = Array.isArray(data.categories) ? data.categories : [];
    const options = list
      .filter(c => c.is_active === undefined || c.is_active === 1 || c.is_active === true)
      .map(c => `<option value="${c.name}">${c.name}</option>`)
      .join("");
    document.getElementById("category").innerHTML = `<option value="">Select Category</option>${options}`;

    // If seller has a fixed store category, preselect and lock
    if (seller && seller.category) {
      const cat = seller.category;
      const select = document.getElementById("category");
      const match = Array.from(select.options).find(o => (o.value || "").toLowerCase() === String(cat).toLowerCase());
      if (match) {
        select.value = match.value;
        select.disabled = true;
      }
    }
    restoreDraft();
    updateSubcategoryCount();
    updatePriceInsight();
  } catch {
    // keep fallback empty if API fails
    restoreDraft();
    updateSubcategoryCount();
    updatePriceInsight();
  }
}

/* ================= API CALL ================= */
async function addProduct(){
  const pname = document.getElementById("pname").value.trim();
  const category = document.getElementById("category").value;
  const subcategory = document.getElementById("subcategory").value.trim();
  const unit = document.getElementById("unit").value;
  const price = document.getElementById("price").value;
  const mrp = document.getElementById("mrp").value;
  const stock = document.getElementById("stock").value;
  const imageFiles = selectedImageFiles.slice(0, 8);

  if(!pname || !category || !unit || !price || !stock || !imageFiles.length){
    await showPopup("Please fill all fields", { title: "Validation Error", type: "error" });
    return;
  }
  if (Number(stock) < 0 || !Number.isInteger(Number(stock))) {
    await showPopup("Stock should be a whole number (0 or greater)", { title: "Validation Error", type: "error" });
    return;
  }
  if (mrp && Number(mrp) > 0 && Number(mrp) < Number(price)) {
    await showPopup("MRP should be greater than or equal to selling price", { title: "Validation Error", type: "error" });
    return;
  }

  const fd = new FormData();
  fd.append("seller_id", seller.id);
  fd.append("name", pname);
  fd.append("category", category);
  if (subcategory) fd.append("sub_category", subcategory);
  fd.append("unit", unit);
  fd.append("price", price);
  if (mrp) fd.append("mrp", mrp);
  fd.append("stock", stock);
  if (imageFiles.length) {
    imageFiles.forEach((f) => fd.append("image", f));
  }

  try{
    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Listing...`;
    }
    const res = await fetch("https://localbasket-backend.onrender.com/api/seller/products", { method:"POST", body:fd });
    const data = await res.json();
    if(data.success){
      localStorage.removeItem(DRAFT_KEY);
      await showPopup("Product added successfully!", { title: "Success", type: "success" });
      location.href="./seller-products.html";
    } else {
      await showPopup(data.message || "Error adding product", { title: "Add Product Failed", type: "error" });
    }
  } catch {
    await showPopup("Server error. Please check if backend is running.", { title: "Server Error", type: "error" });
  } finally {
    if (submitBtn) {
      submitBtn.disabled = false;
      submitBtn.innerHTML = `<i class="fas fa-plus"></i> List Product`;
    }
  }
}

document.getElementById("pname").addEventListener("input", saveDraft);
document.getElementById("category").addEventListener("change", saveDraft);
document.getElementById("unit").addEventListener("change", saveDraft);
priceInput.addEventListener("input", () => { updatePriceInsight(); saveDraft(); });
mrpInput.addEventListener("input", () => { updatePriceInsight(); saveDraft(); });
stockInput.addEventListener("input", saveDraft);
clearDraftBtn.addEventListener("click", () => {
  localStorage.removeItem(DRAFT_KEY);
  location.reload();
});

updateSubcategoryCount();
updatePriceInsight();
loadCategories();
</script>

</body>
</html>

